<div class="output-viewer">
    <div class="output-viewer-header">
        <h3>{{ filename }}</h3>
        <div class="output-viewer-controls">
            <span class="output-viewer-count">{{ total }} QA pairs</span>
            <div class="view-toggle">
                <button class="toggle-btn active" data-view="readable" onclick="toggleOutputView(this, 'readable')">Readable</button>
                <button class="toggle-btn" data-view="json" onclick="toggleOutputView(this, 'json')">JSON</button>
            </div>
            <a href="/api/export/{{ filename }}" class="btn-export" download>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export .XLSX
            </a>
        </div>
    </div>

    <!-- Readable View -->
    <div class="output-viewer-list view-readable active">
        {% for qa in items %}
        <div class="output-qa-item" data-index="{{ qa._index }}">
            <div class="output-qa-header">
                <span class="output-qa-index">#{{ qa._index + 1 }}</span>
                <span class="output-qa-topic">{{ qa.topic if qa.topic else 'physics' }}</span>
                <button class="item-fullscreen-btn" onclick="openItemFullscreenFromBtn(this)" title="View in fullscreen">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                    </svg>
                </button>
            </div>
            <div class="output-qa-question math-content">
                {{ qa.query | texify | safe }}
            </div>
            <details class="output-qa-details" ontoggle="if(this.open && window.MathJax) MathJax.typeset();">
                <summary>View Answer</summary>
                <div class="output-qa-answer">
                    <h4>Answer</h4>
                    <div class="math-content">{{ qa.response_answer | texify | safe }}</div>
                    <h4>Reasoning</h4>
                    <div class="reasoning-content math-content">{{ qa.response_reasoning }}</div>
                </div>
            </details>
        </div>
        {% endfor %}
    </div>

    <!-- JSON View -->
    <div class="output-viewer-list view-json">
        {% for qa in items %}
        <div class="output-qa-item json-item" data-index="{{ qa._index }}">
            <div class="output-qa-header">
                <span class="output-qa-index">#{{ qa._index + 1 }}</span>
                <span class="output-qa-topic">{{ qa.topic if qa.topic else 'physics' }}</span>
                <button class="item-fullscreen-btn" onclick="openItemFullscreenFromBtn(this, true)" title="View in fullscreen">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                    </svg>
                </button>
            </div>
            <pre class="json-content">{{ qa | tojson(indent=2) }}</pre>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Fullscreen Modal -->
<div class="fullscreen-modal" id="fullscreen-modal">
    <div class="fullscreen-backdrop" onclick="closeFullscreen()"></div>
    <div class="fullscreen-container">
        <div class="fullscreen-header">
            <span class="fullscreen-title" id="fullscreen-title"></span>
            <button class="fullscreen-close" onclick="closeFullscreen()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="fullscreen-content" id="fullscreen-content"></div>
    </div>
</div>
<script>
// Toggle between readable and JSON views
function toggleOutputView(btn, view) {
    var container = btn.closest('.output-viewer');

    // Update toggle buttons
    container.querySelectorAll('.toggle-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');

    // Update views
    container.querySelectorAll('.output-viewer-list').forEach(function(v) { v.classList.remove('active'); });
    container.querySelector('.view-' + view).classList.add('active');

    // Re-render MathJax when switching to readable view
    if (view === 'readable' && window.MathJax) {
        MathJax.typeset();
    }
}

// Fullscreen modal functions
function openItemFullscreenFromBtn(btn, isJson) {
    var item = btn.closest('.output-qa-item');
    var index = parseInt(item.dataset.index, 10);
    openItemFullscreen(index, isJson);
}

function openItemFullscreen(index, isJson) {
    var viewer = document.querySelector('.output-viewer');
    var listClass = isJson ? '.view-json' : '.view-readable';
    var item = viewer.querySelector(listClass + ' .output-qa-item[data-index="' + index + '"]');
    var title = 'QA Pair #' + (index + 1);

    document.getElementById('fullscreen-title').textContent = title;
    document.getElementById('fullscreen-content').innerHTML = '<div class="fullscreen-single-item">' + item.innerHTML + '</div>';
    document.getElementById('fullscreen-modal').classList.add('active');
    document.body.style.overflow = 'hidden';

    // Open details if in readable view
    var details = document.querySelector('#fullscreen-content details');
    if (details) {
        details.open = true;
    }

    if (window.MathJax) {
        MathJax.typeset();
    }
}

function closeFullscreen() {
    document.getElementById('fullscreen-modal').classList.remove('active');
    document.body.style.overflow = '';
}

// Close on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeFullscreen();
    }
});

// Render MathJax for the loaded content
if (window.MathJax) {
    MathJax.typeset();
}
</script>
